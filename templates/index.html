<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ArquitectAI</title>
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    .logo {
      width: 50px;
      height: 50px;
      display: block;
      margin: 0 auto;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #282828;
        color: #ececf1;
        height: 100vh;
        display: flex;
        overflow: hidden;
    }

    /* Auth Modal Styles */
    .auth-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
    }

    .auth-modal {
        background-color: #202123;
        border-radius: 16px;
        padding: 32px;
        width: 100%;
        max-width: 420px;
        margin: 20px;
        border: 1px solid #4d4d4f;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .auth-header {
        text-align: center;
        margin-bottom: 32px;
    }

    .auth-logo {
        font-size: 48px;
        margin-bottom: 16px;
    }

    .auth-title {
        font-size: 28px;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 8px;
    }

    .auth-subtitle {
        color: #9ca3af;
        font-size: 16px;
    }

    .auth-tabs {
        display: flex;
        margin-bottom: 24px;
        background-color: #40414f;
        border-radius: 8px;
        padding: 4px;
    }

    .auth-tab {
        flex: 1;
        padding: 10px 16px;
        background: transparent;
        border: none;
        color: #ececf1;
        cursor: pointer;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .auth-tab.active {
        background-color: #10a37f;
        color: white;
    }

    .auth-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-label {
        font-size: 14px;
        font-weight: 500;
        color: #ececf1;
    }

    .form-input {
        padding: 12px 16px;
        background-color: #40414f;
        border: 1px solid #565869;
        border-radius: 8px;
        color: #ececf1;
        font-size: 16px;
        outline: none;
        transition: border-color 0.2s;
    }

    .form-input:focus {
        border-color: #10a37f;
    }

    .form-input::placeholder {
        color: #9ca3af;
    }

    .auth-button {
        padding: 12px 24px;
        background-color: #10a37f;
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: 8px;
    }

    .auth-button:hover {
        background-color: #0d8266;
    }

    .auth-button:disabled {
        background-color: #565869;
        cursor: not-allowed;
    }

    .auth-error {
        background-color: #dc2626;
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 16px;
        display: none;
    }

    .auth-success {
        background-color: #16a34a;
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 16px;
        display: none;
    }

    .loading-spinner {
        border: 2px solid #565869;
        border-top: 2px solid #10a37f;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .hidden {
        display: none !important;
    }

    /* Sidebar */
    .sidebar {
        width: 260px;
        background-color: #202123;
        border-right: 1px solid #4d4d4f;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease;
    }

    .sidebar.hidden {
        transform: translateX(-100%);
    }

    .sidebar-header {
        padding: 12px 16px;
        border-bottom: 1px solid #4d4d4f;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .sidebar-toggle {
        display: none;
        width: 32px;
        height: 32px;
        background: transparent;
        border: none;
        color: #ececf1;
        cursor: pointer;
        border-radius: 4px;
        font-size: 16px;
    }

    .sidebar-toggle:hover {
        background-color: #40414f;
    }

    .new-chat-btn {
        flex: 1;
        padding: 8px 12px;
        background-color: #10a37f;
        border: none;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        transition: background-color 0.2s;
    }

    .new-chat-btn:hover {
        background-color: #0d8266;
    }

    .chat-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }

    .chat-item {
        padding: 10px 12px;
        margin-bottom: 4px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1.4;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative; /* Added for dropdown positioning */
    }

    .chat-item:hover {
        background-color: #40414f;
    }

    .chat-item.active {
        background-color: #343541;
    }

    .chat-item-content {
        flex: 1;
        min-width: 0;
    }

    .chat-item-title {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-item-actions {
        opacity: 0;
        display: flex;
        gap: 4px;
        transition: opacity 0.2s;
    }

    .chat-item:hover .chat-item-actions {
        opacity: 1;
    }

    .chat-action-btn {
        width: 24px;
        height: 24px;
        background: transparent;
        border: none;
        color: #ececf1;
        cursor: pointer;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }

    .chat-messages {
    height: 400px; /* Altura fija */
    overflow-y: auto; /* Scroll vertical */
    overflow-x: hidden; /* Sin scroll horizontal */
    }
    
    .chat-action-btn:hover {
        background-color: #4a4b5a;
    }

    .sidebar-footer {
        padding: 16px;
        border-top: 1px solid #4d4d4f;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .user-info:hover {
        background-color: #40414f;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
    }

    .user-details {
        flex: 1;
        min-width: 0;
    }

    .user-name {
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .user-email {
        font-size: 12px;
        color: #9ca3af;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Main content area */
    .main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    /* Header con t√≠tulo y botones */
    .header {
        background-color: #202123;
        border-bottom: 1px solid #4d4d4f;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .mobile-sidebar-toggle {
        display: none;
        width: 32px;
        height: 32px;
        background: transparent;
        border: none;
        color: #ececf1;
        cursor: pointer;
        border-radius: 4px;
        font-size: 16px;
    }

    .mobile-sidebar-toggle:hover {
        background-color: #40414f;
    }

    .app-title {
        font-size: 24px;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header-buttons {
        display: flex;
        gap: 12px;
    }

    .header-btn {
        padding: 8px 16px;
        background: transparent;
        border: 1px solid #4d4d4f;
        border-radius: 6px;
        color: #ececf1;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .header-btn:hover {
        background-color: #40414f;
        border-color: #565869;
    }

    /* Main content */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        min-height: 0; /* Importante para que flex funcione correctamente */
    }

    .chat-container {
        flex: 1;         /* altura fija o m√°xima */
        overflow-y: auto;      /* para que aparezca la barra vertical */
        padding: 20px 0;
        min-height: 0;         /* Permite que el contenedor se reduzca */
    }

    .message {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        gap: 16px;
    }

    .message.user {
        background-color: #282828;
    }

    .message.assistant {
        background-color: #282828;
    }

    .message-avatar {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .user-avatar-msg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: bold;
    }

    .assistant-avatar-msg {
        background: #10a37f;
        color: white;
        font-weight: bold;
    }

    .message-content {
        flex: 1;
        line-height: 1.6;
    }

    .message-content p {
        margin-bottom: 12px;
    }

    .message-content p:last-child {
        margin-bottom: 0;
    }

    .message-content pre {
        background-color: #2d2d2d;
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 12px 0;
    }

    .message-content code {
        background-color: #2d2d2d;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Monaco', 'Consolas', monospace;
    }

    /* Input area */
    .input-container {
        padding: 20px;
        background-color: #343541;
        border-top: 1px solid #4d4d4f;
    }

    .input-wrapper {
        max-width: 800px;
        margin: 0 auto;
        position: relative;
        display: flex;
        gap: 8px;
        align-items: flex-end;
    }

    .chat-input {
        flex: 1;
        padding: 12px 48px 12px 16px;
        background-color: #40414f;
        border: 1px solid #565869;
        border-radius: 12px;
        color: #ececf1;
        font-size: 16px;
        resize: none;
        outline: none;
        min-height: 48px;
        max-height: 200px;
    }

    .chat-input:focus {
        border-color: #10a37f;
    }

    .file-input-btn {
        width: 40px;
        height: 40px;
        background-color: #40414f;
        border: 1px solid #565869;
        border-radius: 8px;
        color: #ececf1;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: all 0.2s;
    }

    .file-input-btn:hover {
        background-color: #4a4b5a;
    }

    .file-input-hidden {
        display: none;
    }

    .send-button {
        width: 40px;
        height: 40px;
        background-color: #10a37f;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }

    .send-button:hover {
        background-color: #0d8266;
    }

    .send-button:disabled {
        background-color: #565869;
        cursor: not-allowed;
    }

    /* Welcome screen */
    .welcome-screen {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 20px;
    }

    .welcome-subtitle {
        font-size: 32px;
        font-weight: 600;
        margin-bottom: 32px;
        color: #ececf1;
    }

    .example-prompts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;
        max-width: 800px;
        width: 100%;
    }

    .example-prompt {
        padding: 16px;
        background-color: #40414f;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
        border: 1px solid #565869;
    }

    .example-prompt:hover {
        background-color: #4a4b5a;
    }

    .example-prompt h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #ececf1;
    }

    .example-prompt p {
        font-size: 14px;
        color: #c5c5d2;
    }

    /* File preview */
    .file-preview {
        margin: 10px 0;
        padding: 10px;
        background-color: #40414f;
        border-radius: 8px;
        border: 1px solid #565869;
    }

    .file-preview img {
        max-width: 200px;
        border-radius: 6px;
    }

    /* Dropdown para opciones de chat */
    .chat-options-menu { /* Renamed from .chat-options */
        position: absolute;
        top: 50%; /* Adjusted for better positioning relative to chat item */
        right: 10px;
        transform: translateY(-50%);
        background-color: #40414f;
        border: 1px solid #565869;
        border-radius: 6px;
        padding: 8px 0;
        min-width: 120px;
        z-index: 1000;
        display: none;
    }

    .chat-options-menu.visible {
        display: block;
    }

    .chat-options-menu button {
        width: 100%;
        padding: 8px 16px;
        background: none;
        border: none;
        color: #ececf1;
        cursor: pointer;
        text-align: left;
        font-size: 14px;
        transition: background-color 0.2s;
    }

    .chat-options-menu button:hover {
        background-color: #4a4b5a;
    }

    /* Overlay para m√≥vil */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 998;
    }

    .sidebar-overlay.visible {
        display: block;
    }

    /* Media queries */
    @media (max-width: 768px) {
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 999;
            transform: translateX(-100%);
        }

        .sidebar.visible {
            transform: translateX(0);
        }

        .mobile-sidebar-toggle {
            display: flex;
        }
        
        .header {
            flex-direction: column;
            gap: 12px;
        }
        
        .header-buttons {
            width: 100%;
            justify-content: center;
        }
        
        .message {
            padding: 16px;
        }

        .app-title {
            font-size: 20px;
        }
    }
  </style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <div class="auth-header">
                <div class="auth-logo"><img src="/static/logo3.png" alt="Logo" style="width: 50px; height: auto;"/></div>
                <h1 class="auth-title">ArquitectAI</h1>
                <p class="auth-subtitle">Tu asistente de arquitectura inteligente</p>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab" onclick="switchTab('login')">
                    Iniciar Sesi√≥n
                </button>
                <button class="auth-tab" id="registerTab" onclick="switchTab('register')">
                    Registrarse
                </button>
            </div>

            <div class="auth-error" id="authError"></div>
            <div class="auth-success" id="authSuccess"></div>

            <!-- Login Form -->
            <form class="auth-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label" for="loginEmail">Email</label>
                    <input 
                        type="email" 
                        id="loginEmail" 
                        class="form-input" 
                        placeholder="tu@email.com"
                        required
                    >
                </div>
                <div class="form-group">
                    <label class="form-label" for="loginPassword">Contrase√±a</label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        class="form-input" 
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        required
                    >
                </div>
                <button type="submit" class="auth-button" id="loginButton">
                    Iniciar Sesi√≥n
                </button>
            </form>

            <!-- Register Form -->
            <form class="auth-form hidden" id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label" for="registerName">Nombre</label>
                    <input 
                        type="text" 
                        id="registerName" 
                        class="form-input" 
                        placeholder="Tu nombre"
                        required
                    >
                </div>
                <div class="form-group">
                    <label class="form-label" for="registerEmail">Email</label>
                    <input 
                        type="email" 
                        id="registerEmail" 
                        class="form-input" 
                        placeholder="tu@email.com"
                        required
                    >
                </div>
                <div class="form-group">
                    <label class="form-label" for="registerPassword">Contrase√±a</label>
                    <input 
                        type="password" 
                        id="registerPassword" 
                        class="form-input" 
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        required
                        minlength="6"
                    >
                </div>
                <div class="form-group">
                    <label class="form-label" for="registerPasswordConfirm">Confirmar Contrase√±a</label>
                    <input 
                        type="password" 
                        id="registerPasswordConfirm" 
                        class="form-input" 
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        required
                        minlength="6"
                    >
                </div>
                <button type="submit" class="auth-button" id="registerButton">
                    Registrarse
                </button>
            </form>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="createNewChat()">
                <span>+</span>
                Nuevo Chat
            </button>
        </div>
        
        <div class="chat-list" id="chatList">
            <!-- Los chats se generar√°n din√°micamente aqu√≠ -->
        </div>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <img src="/static/logo3.png" alt="Logo" style="width: 35px; height: auto;"/>
                <div class="user-details">
                    <div class="user-name">
                      {{ username }}
                    </div>
                    <div class="user-email">ArquitectAIüß±</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay para m√≥vil -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileSidebar()"></div>

    <!-- √Årea principal -->
    <div class="main-area">
        <!-- Header con t√≠tulo y botones principales -->
        <div class="header">
            <div class="header-left">
                <button class="mobile-sidebar-toggle" onclick="toggleMobileSidebar()">
                    ‚ò∞
                </button>
                <img src="/static/logo.png" alt="Logo" style="width: 40px; height: auto;"/>
                <h1 class="app-title">ArquitectAI</h1>
            </div>
            
            <div class="header-buttons">
                <!-- Bot√≥n de opciones eliminado -->
                
                <button class="header-btn" onclick="showChatHistory()">
                    <span>üìã</span>
                    Historial
                </button>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="main-content">
            <div class="chat-container" id="chatContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <h2 class="welcome-subtitle">¬øEn qu√© puedo ayudarte hoy?</h2>
                    
                    <div class="example-prompts">
                        <div class="example-prompt" onclick="sendExampleMessage('Hola! Necesito que me expliques unos conceptos')">
                            <h3>üí° Explicar conceptos</h3>
                            <p>¬øQu√© conceptos necesitas saber?</p>
                        </div>
                        
                        <div class="example-prompt" onclick="sendExampleMessage('Ay√∫dame a acotar un plano')">
                            <h3>üìè Ayuda con acotaciones</h3>
                            <p>Ay√∫dame a acotar un plano</p>
                        </div>
                        
                        <div class="example-prompt" onclick="sendExampleMessage('Dame ideas creativas para un proyecto')">
                            <h3>üé® Ideas creativas</h3>
                            <p>¬øNecesitas ideas creativas para un proyecto?</p>
                        </div>
                        
                        <div class="example-prompt" onclick="sendExampleMessage('Hola! Te voy a preguntar sobre un artista, quiero que me cuentes todo lo que sepas de el')">
                            <h3>üåç Informaci√≥n sobre artistas</h3>
                            <p>¬øNecesitas informaci√≥n?</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √Årea de entrada -->
            <div class="input-container">
                <div class="input-wrapper">
                    <button class="file-input-btn" onclick="document.getElementById('fileInput').click()" title="Adjuntar archivo">
                        üìé
                    </button>
                    <input type="file" id="fileInput" class="file-input-hidden" 
                           accept=".pdf,.dwg,.dxf,.png,.jpg,.jpeg,.bmp,.svg,.tiff,.webp,.heic,.gif,.docx,.pptx,.psd,.indd"
                           onchange="handleFileSelect(event)">
                    
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Env√≠a un mensaje..."
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                        oninput="adjustTextareaHeight()"
                    ></textarea>
                    
                    <button class="send-button" id="sendButton" onclick="sendMessage()" title="Enviar mensaje">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chats = [];
        let currentChatId = null;
        let isWelcomeVisible = true;
        let chatHistory = [];

        // Inicializar
        function loadChats() {
            const saved = localStorage.getItem('arquitectAI_chats');
            if (saved) {
                chats = JSON.parse(saved);
            } else {
                chats = [];
            }
        }

        function saveChats() {
            localStorage.setItem('arquitectAI_chats', JSON.stringify(chats));
        }

        function createNewChat() {
            const id = Date.now().toString();
            const newChat = {
                id,
                nombre: `Chat ${chats.length + 1}`,
                mensajes: []
            };
            chats.unshift(newChat); // A√±adir al principio
            currentChatId = id;
            saveChats();
            resetToWelcomeScreen();
            renderChatList();
        }

        function getBotResponse(userInput) {
            userInput = userInput.toLowerCase().trim();
            
            // Respuestas para saludos b√°sicos
            if (userInput.includes('hola') || userInput.includes('hi')) {
                return '¬°Hola! Soy ArquitectAI, tu asistente especializado en arquitectura. ¬øEn qu√© puedo ayudarte hoy?';
            }
            
            if (userInput.includes('c√≥mo est√°s') || userInput.includes('como estas')) {
                return '¬°Estoy funcionando perfectamente! Gracias por preguntar. ¬øY t√∫ c√≥mo est√°s?';
            }

            if (userInput.includes('gracias') || userInput.includes('muchas gracias')) {
                return 'De nada, estoy aqu√≠ para ayudarte. ¬øHay algo m√°s en lo que pueda asistirte?';
            }

            if (userInput.includes('adi√≥s') || userInput.includes('chao')) {
                return '¬°Hasta pronto! Que tengas un excelente d√≠a.';
            }

            // Respuestas para preguntas comunes sobre arquitectura
            if (userInput.includes('explicar conceptos') || userInput.includes('conceptos de arquitectura')) {
                return 'Claro, ¬øqu√© concepto espec√≠fico de arquitectura te gustar√≠a que te explique? Por ejemplo, puedo hablarte sobre el estilo Bauhaus, la sostenibilidad en la construcci√≥n, o la importancia de la luz natural en el dise√±o.';
            }

            if (userInput.includes('acotar un plano') || userInput.includes('ayuda con acotaciones')) {
                return 'Para acotar un plano correctamente, es fundamental seguir ciertas normas. ¬øEst√°s trabajando con un software espec√≠fico como AutoCAD o Revit, o necesitas principios generales de acotaci√≥n?';
            }

            if (userInput.includes('ideas creativas') || userInput.includes('proyecto de arquitectura')) {
                return '¬°Me encanta la creatividad! Para darte las mejores ideas, cu√©ntame un poco m√°s sobre tu proyecto: ¬øCu√°l es su prop√≥sito, qu√© tipo de espacio es, y qu√© estilo o materiales te interesan?';
            }

            if (userInput.includes('informaci√≥n sobre artistas') || userInput.includes('arquitectos famosos')) {
                return 'Con gusto te proporciono informaci√≥n sobre artistas o arquitectos. ¬øHay alguien en particular que te interese, como Zaha Hadid, Frank Lloyd Wright, o Le Corbusier?';
            }

            // Respuestas m√°s generales y coherentes
            if (userInput.includes('qu√© puedes hacer') || userInput.includes('para qu√© sirves')) {
                return 'Soy ArquitectAI, un asistente dise√±ado para ayudarte con consultas sobre arquitectura, dise√±o, construcci√≥n, normativas, historia de la arquitectura, y mucho m√°s. ¬°Preg√∫ntame lo que necesites!';
            }

            if (userInput.includes('dime algo interesante')) {
                return '¬øSab√≠as que el Pante√≥n de Roma, construido hace casi 2000 a√±os, sigue siendo la c√∫pula de hormig√≥n sin armar m√°s grande del mundo? Es una maravilla de la ingenier√≠a romana.';
            }
            
            // Respuesta por defecto m√°s √∫til
            return 'Entiendo. Para poder ayudarte mejor, ¬øpodr√≠as darme m√°s detalles sobre lo que necesitas o reformular tu pregunta? Estoy aqu√≠ para asistirte en temas de arquitectura.';
         }

        function selectChat(id) {
            if (currentChatId === id) return;
            currentChatId = id;
            renderMessages();
            renderChatList();
            
            // Cerrar sidebar en m√≥vil
            if (window.innerWidth <= 768) {
                closeMobileSidebar();
            }
        }

        function renderChatList() {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';
            
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                chatItem.onclick = () => selectChat(chat.id);
                
                chatItem.innerHTML = `
                    <div class="chat-item-content">
                        <div class="chat-item-title">${chat.nombre}</div>
                    </div>
                    <div class="chat-item-actions">
                        <button class="chat-action-btn" onclick="event.stopPropagation(); toggleChatOptionsMenu(event, '${chat.id}')" title="Opciones del chat">
                            ‚ãØ
                        </button>
                        <div class="chat-options-menu" id="chatOptionsMenu-${chat.id}">
                            <button onclick="event.stopPropagation(); renameChatInSidebar('${chat.id}')">Renombrar</button>
                            <button onclick="event.stopPropagation(); deleteChatFromSidebar('${chat.id}')">Eliminar</button>
                        </div>
                    </div>
                `;
                
                chatList.appendChild(chatItem);
            });
        }

        function toggleChatOptionsMenu(event, chatId) {
            event.stopPropagation(); // Prevent selecting the chat when clicking the menu button
            const menu = document.getElementById(`chatOptionsMenu-${chatId}`);
            // Close all other menus
            document.querySelectorAll('.chat-options-menu').forEach(m => {
                if (m.id !== `chatOptionsMenu-${chatId}`) {
                    m.classList.remove('visible');
                }
            });
            menu.classList.toggle('visible');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            document.querySelectorAll('.chat-options-menu').forEach(menu => {
                if (!menu.contains(event.target) && !event.target.classList.contains('chat-action-btn')) {
                    menu.classList.remove('visible');
                }
            });
        });


        function renameChatInSidebar(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            const newName = prompt('Nuevo nombre para el chat:', chat.nombre);
            if (newName && newName.trim()) {
                chat.nombre = newName.trim();
                saveChats();
                renderChatList();
            }
            document.getElementById(`chatOptionsMenu-${chatId}`).classList.remove('visible'); // Close menu
        }

        function deleteChatFromSidebar(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            if (confirm(`¬øEliminar "${chat.nombre}"? Esta acci√≥n no se puede deshacer.`)) {
                chats = chats.filter(c => c.id !== chatId);
                
                if (chats.length === 0) {
                    createNewChat();
                } else if (currentChatId === chatId) {
                    selectChat(chats[0].id);
                } else {
                    renderChatList();
                }
                
                saveChats();
            }
            document.getElementById(`chatOptionsMenu-${chatId}`).classList.remove('visible'); // Close menu
        }

        function renderMessages() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            
            if (!currentChatId) return;

            const chat = chats.find(c => c.id === currentChatId);
            if (!chat || chat.mensajes.length === 0) {
                resetToWelcomeScreen();
                return;
            }

            isWelcomeVisible = false;
            chat.mensajes.forEach(msg => {
                if (msg.tipo === 'texto') {
                    addMessageToDOM(msg.sender, msg.texto);
                } else if (msg.tipo === 'archivo') {
                    addFilePreviewToDOM(msg.fileName, msg.fileType, msg.fileURL);
                }
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function resetToWelcomeScreen() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = `
                <div class="welcome-screen" id="welcomeScreen">
                    <h2 class="welcome-subtitle">¬øEn qu√© puedo ayudarte hoy?</h2>
                    
                    <div class="example-prompts">
                        <div class="example-prompt" onclick="sendExampleMessage('Hola! Necesito que me expliques unos conceptos')">
                            <h3>üí° Explicar conceptos</h3>
                            <p>¬øQu√© conceptos necesitas saber?</p>
                        </div>
                        
                        <div class="example-prompt" onclick="sendExampleMessage('Ay√∫dame a acotar un plano')">
                            <h3>üìè Ayuda con acotaciones</h3>
                            <p>Ay√∫dame a acotar un plano</p>
                        </div>
                        
                        <div class="example-prompt" onclick="sendExampleMessage('Dame ideas creativas para un proyecto')">
                            <h3>üé® Ideas creativas</h3>
                            <p>¬øNecesitas ideas creativas para un proyecto?</p>
                        </div>
                        
                        <div class="example-prompt" onclick="sendExampleMessage('Hola! Te voy a preguntar sobre un artista, quiero que me cuentes todo lo que sepas de el')">
                            <h3>üåç Informaci√≥n sobre artistas</h3>
                            <p>¬øNecesitas informaci√≥n?</p>
                        </div>
                    </div>
                </div>
            `;
            isWelcomeVisible = true;
        }

        function adjustTextareaHeight() {
            const textarea = document.getElementById('chatInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!currentChatId) {
                createNewChat();
            }

            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) return;
            
            hideWelcomeScreen();
            
            // Agregar mensaje del usuario
            chat.mensajes.push({ tipo: 'texto', texto: message, sender: 'user' });
            addMessageToDOM('user', message);
            
            // Actualizar t√≠tulo del chat si es el primer mensaje
            if (chat.mensajes.length === 1) {
                chat.nombre = message.length > 30 ? message.substring(0, 30) + '...' : message;
                renderChatList();
            }
            
            input.value = '';
            adjustTextareaHeight();
            
            // Enviar prompt al backend con Ollama
fetch('/api/generar-texto', {
    method: 'POST',
    body: new URLSearchParams({ prompt: message })
})
.then(response => response.json())
.then(data => {
    const respuesta = data.respuesta || 'Error: sin respuesta.';
    chat.mensajes.push({ tipo: 'texto', texto: respuesta, sender: 'assistant' });
    addMessageToDOM('assistant', respuesta);
    saveChats();
})
.catch(error => {
    console.error('Error al contactar con el backend:', error);
    chat.mensajes.push({ tipo: 'texto', texto: 'Error al obtener respuesta del asistente.', sender: 'assistant' });
    addMessageToDOM('assistant', 'Error al obtener respuesta del asistente.');
    saveChats();
});

            
            saveChats();
        }

        function sendExampleMessage(message) {
            const input = document.getElementById('chatInput');
            input.value = message;
            sendMessage();
        }

        function addMessageToDOM(sender, content) {
            const chatContainer = document.getElementById('chatContainer');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            
            if (sender === 'user') {
                avatar.className += ' user-avatar-msg';
                avatar.textContent = 'U';
            } else {
                avatar.className += ' assistant-avatar-msg';
                avatar.innerHTML = 'üèóÔ∏è';
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = `<p>${content}</p>`;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
           document.addEventListener('DOMContentLoaded', function() {
    loadChats();
    if (chats.length === 0) {
        createNewChat();
    } else {
        selectChat(chats[0].id);
    }
    adjustTextareaHeight();
    renderChatList();
});
  
function hideWelcomeScreen() {
    const welcome = document.getElementById('welcomeScreen');
    if (welcome) welcome.remove();
}

function addFilePreviewToDOM(fileName, fileType, fileURL) {
    const chatContainer = document.getElementById('chatContainer');

    const messageDiv = document.createElement('div');
    messageDiv.className = `message user`;

    const avatar = document.createElement('div');
    avatar.className = 'message-avatar user-avatar-msg';
    avatar.textContent = 'U';

    const content = document.createElement('div');
    content.className = 'message-content';

    if (fileType.startsWith('image/')) {
        content.innerHTML = `
            <p>Archivo adjunto: ${fileName}</p>
            <img src="${fileURL}" alt="${fileName}" style="max-width: 200px; border-radius: 8px;" />
        `;
    } else {
        content.innerHTML = `<p>Archivo adjunto: <a href="${fileURL}" target="_blank">${fileName}</a></p>`;
    }

    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    const fileURL = URL.createObjectURL(file);
    const chat = chats.find(c => c.id === currentChatId);
    if (!chat) return;

    chat.mensajes.push({
        tipo: 'archivo',
        fileName: file.name,
        fileType: file.type,
        fileURL: fileURL
    });

    addMessageToDOM('user', `Archivo adjunto: ${file.name}`); // Show file attachment as a user message
    saveChats();
}

// Mobile sidebar toggle functions
function toggleMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.toggle('visible');
    overlay.classList.toggle('visible');
}

function closeMobileSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.remove('visible');
    overlay.classList.remove('visible');
}

function switchTab(tab) {
    const loginTab = document.getElementById('loginTab');
    const registerTab = document.getElementById('registerTab');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const authError = document.getElementById('authError');
    const authSuccess = document.getElementById('authSuccess');

    // Limpiar mensajes de error/√©xito al cambiar de pesta√±a
    authError.style.display = 'none';
    authSuccess.style.display = 'none';

    if (tab === 'login') {
        loginTab.classList.add('active');
        registerTab.classList.remove('active');
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
    } else {
        loginTab.classList.remove('active');
        registerTab.classList.add('active');
        loginForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
    }
}

function handleLogin(event) {
    event.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const loginButton = document.getElementById('loginButton');
    const authError = document.getElementById('authError');
    const authSuccess = document.getElementById('authSuccess');
    const authOverlay = document.getElementById('authOverlay');

    authError.style.display = 'none';
    authSuccess.style.display = 'none';
    loginButton.disabled = true;
    loginButton.innerHTML = '<div class="loading-spinner"></div>';

    fetch('/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, password })
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
        if (status === 200) {
            authSuccess.textContent = body.message;
            authSuccess.style.display = 'block';
            localStorage.setItem('isLoggedIn', 'true');

            // ‚úÖ Cambia esto: recarga la p√°gina tras √©xito
            setTimeout(() => {
                window.location.href = '/';  // ‚è™ Fuerza reload para que {{ username }} funcione
            }, 1000);

        } else {
            authError.textContent = body.error || 'Error desconocido.';
            authError.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error de red o del servidor:', error);
        authError.textContent = 'Error de conexi√≥n. Int√©ntalo de nuevo.';
        authError.style.display = 'block';
    })
    .finally(() => {
        loginButton.disabled = false;
        loginButton.innerHTML = 'Iniciar Sesi√≥n';
    });
}

// Ejemplo para handleRegister (similar)
function handleRegister(event) {
    event.preventDefault();
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
    const registerButton = document.getElementById('registerButton');
    const authError = document.getElementById('authError');
    const authSuccess = document.getElementById('authSuccess');

    authError.style.display = 'none';
    authSuccess.style.display = 'none';

    if (password !== passwordConfirm) {
        authError.textContent = 'Las contrase√±as no coinciden.';
        authError.style.display = 'block';
        return;
    }
    if (password.length < 6) { // Validaci√≥n frontend
        authError.textContent = 'La contrase√±a debe tener al menos 6 caracteres.';
        authError.style.display = 'block';
        return;
    }

    registerButton.disabled = true;
    registerButton.innerHTML = '<div class="loading-spinner"></div>';

    fetch('/register', { // Aseg√∫rate que la URL sea correcta
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, email, password })
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
        if (status === 201) { // 201 Created
            authSuccess.textContent = body.message;
            authSuccess.style.display = 'block';
            switchTab('login'); // Cambiar a login despu√©s de un registro exitoso
        } else {
            authError.textContent = body.error || 'Error desconocido.';
            authError.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error de red o del servidor:', error);
        authError.textContent = 'Error de conexi√≥n. Int√©ntalo de nuevo.';
        authError.style.display = 'block';
    })
    .finally(() => {
        registerButton.disabled = false;
        registerButton.innerHTML = 'Registrarse';
    });
}

function hacerPregunta() {
  const pregunta = document.getElementById('preguntaInput').value;

  fetch('/preguntar', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      pregunta: pregunta,
      usar_serper: true  // üëà Esto activa la b√∫squeda online
    })
  })
  .then(response => response.json())
  .then(data => {
    console.log("Respuesta:", data.respuesta);
  });
}

document.addEventListener('DOMContentLoaded', () => {
    const authOverlay = document.getElementById('authOverlay');
    const isLoggedIn = localStorage.getItem('isLoggedIn'); // O tu m√©todo de verificaci√≥n de sesi√≥n

    if (isLoggedIn === 'true') {
        authOverlay.style.display = 'none'; // Ocultar el modal si ya est√° logueado
    } else {
        authOverlay.style.display = 'flex'; // Mostrar el modal si no est√° logueado
        switchTab('login'); // Asegurarse de que la pesta√±a de login est√© activa por defecto
    }
});

</script>
</body>
</html>
